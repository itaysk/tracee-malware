#! /bin/bash
# elfexec: https://github.com/abbat/elfexec
# Args: file to execute
set -ex

[ -z "$1" ] && echo "missing args" && exit 1
sudo -v

# pre run cleanup
sudo rm -r ./out || true
mkdir ./out

# post run (or error) cleanup
trap end EXIT
function end() {
  sudo pkill -P $(jobs -p)
  sudo chown -R $USER ./out
}

# run tracee in the background
sudo /home/itaysk/bin/tracee --output-path ./out \
  -e do_exit -e execve -e execveat -e memfd_create -e vfs_write \
  --capture write --filter-file-write memfd > ./out/out &

# allow for all the ebpf programs to load and hook
sleep 10

# file-less execute
/home/itaysk/bin/elfexec < "$1"

# allow tracee to collect and process the events
sleep 3