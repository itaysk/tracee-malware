#! /bin/bash
# Args: image name
set -ex

[ -z "$1" ] && echo "missing args" && exit 1
sudo -v

# pre run cleanup
sudo rm -r ./out || true
mkdir ./out

# post run (or error) cleanup
trap end EXIT
function end() {
  #docker stop $container
  sudo pkill -P $(jobs -p)
  sudo chown -R $USER ./out
}

# run tracee in the background
sudo /home/itaysk/bin/tracee --output-path ./out -c \
  --capture mem --capture write --security-alerts --blob-perf-buffer-size 16384 > ./out/out &

# allow for all the ebpf programs to load and hook
sleep 10

# run container
container=$(docker run --rm -P -d "$1")
# allow container to start
sleep 15
# exercise service (optional)
container_port=$(docker port $container 8080 | cut -d ':' -f 2)
curl "http://localhost:$container_port"

# allow tracee to collect and process the events
sleep 3
