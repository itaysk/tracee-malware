#! /bin/bash
# Args: URL to download
set -ex

[ -z "$1" ] && echo "missing args" && exit 1
sudo -v

# pre run cleanup
sudo rm -r ./out || true
mkdir ./out
rm ./dropped || true

# post run (or error) cleanup
trap end EXIT
function end() {
  sudo pkill -P $(jobs -p)
  sudo chown -R $USER ./out
}

# run tracee in the background
sudo /home/itaysk/bin/tracee --output-path ./out \
  -e do_exit -e execve -e execveat -e connect -e fchmod -e fchmodat \
  --capture write --filter-file-write $PWD > ./out/out &

# allow for all the ebpf programs to load and hook
sleep 10

# drop and execute
wget -O dropped "$1"
chmod +x ./dropped
./dropped

# allow tracee to collect and process the events
sleep 3
